{% extends 'layout.html' %}
{% block content %}
<!-- ############ PAGE START-->
<div class="padding">
  <div class="box">
    <div class="box-header">
      <h3>{{subtitle}}</h3>
    </div>
    <div class="box-body">
      <div class="row p-a">
        <div class="col-sm-5">
          <a href="#" data-toggle="modal" data-target="#project-modal" class="btn btn-outline b-primary text-primary">Add New Project</a>
        </div>
      </div>
      <div class="table-responsive">
        <table id="projects-overview" class="table table-striped b-t b-b dataTable no-footer" ui-jp="dataTable">
          <thead>
          <tr>
            <th></th>
            <th>Project Nr</th>
            <th>Community</th>
            <th>Street</th>
            <th>House Nr</th>
            <th>Finished/All</th>
            <th data-sort-ignore="true">Project Types</th>
            <th style="width:20px;" data-sort-ignore="true"></th>
            <th style="width:20px;" data-sort-ignore="true"></th>
          </tr>
          </thead>
          <tbody>
          {% for project in projects %}
          <tr>
            <td class="details-control"></td>
            <td>{{project.id}}</td>
            <td>{{project.community}}</td>
            <td>{{project.street}}</td>
            <td>{{project.housenr}}</td>
            <td>{{project.zipcode}}</td>
            <td>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.electric >0 %} checked {% endif %}><i class="red"></i>
              </label>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.water >0 %} checked {% endif %}><i class="green"></i>
              </label>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.light >0 %} checked {% endif %}><i class="blue"></i>
              </label>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.telecom >0 %} checked {% endif %}><i class="orange"></i>
              </label>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.gas >0 %} checked {% endif %}><i class="yellow"></i>
              </label>
              <label class="md-check" style="display: inline-block">
              <input type="checkbox" {% if project.contract_types.others >0 %} checked {% endif %}><i class="grey"></i>
              </label>
            </td>
            <td>
              <a href="#" data-toggle="modal" data-target="#contract-basic-modal" data-project="{{project|json}}"><i class="material-icons md-24">&#xe03b;</i></a>
            </td>
            <td>
              <a href="#" data-toggle="modal" data-target="#project-modal" data-project="{{project|json}}"><i class="material-icons md-24">&#xe3c9;</i></a>
            </td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- add and edit project modal -->
{% include 'modal_project.html' %}

<!-- add and edit contract basic modal -->
{% include 'modal_contract_basic.html' %}

<!-- add and edit contract basic modal -->
{% include 'modal_contract_building_permissions.html' %}

<!-- add and edit contract basic modal -->
{% include 'modal_contract_building.html' %}

<!-- add and edit contract basic modal -->
{% include 'modal_contract_ofw.html' %}

<!-- add and edit contract basic modal -->
{% include 'modal_contract_invoices.html' %}


<iframe id="file_tobe_printed" src="" hidden></iframe>

<!-- / .modal -->
<!-- ############ PAGE END-->

<!-- project scripts -->
<script src="/scripts/app_project.js"></script>
<script src="/scripts/app_contract.js"></script>
<script src="/scripts/app_com.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    //project event handler
    // add and edit project
    $('#project-modal').on('show.bs.modal', function (e) {
        $(this).find('form')[0].reset();
        var project = $(e.relatedTarget).data('project');
        if (project) {
            //set title
            $('#project-modal-title').text('Update Project');

            //set form action
            $('#project-modal-form').attr('action', '/projects/update/' + project.id);

            //set content
            $("#city").val(project.city);
            $("#community").val(project.community);
            $("#street").val(project.street);
            $("#housenr").val(project.housenr);
            $("#files_path").val(project.files_path);
            $("#linesplan_files_path").val(project.linesplan_files_path);
            $("#zipcode").val(project.zipcode);
            $("#comment").val(project.comment);
        } else {
            //set title
            $('#project-modal-title').text('Add Project');

            //set form action
            $('#project-modal-form').attr('action', '/projects/add');

        }
    });

    var projects_table = $('#projects-overview').DataTable();

    // loading the contracts of a project
    $('#projects-overview tbody').on('click', 'td.details-control', function (e) {
        // Stop form submitting normally
        e.preventDefault();

        var projects_tr = $(this).closest('tr');
        var projects_table_row = projects_table.row(projects_tr);
        var project_id = projects_table_row.data()[1];

        if (projects_table_row.child.isShown()) {
            // This row is already open - close it
            projects_table_row.child.hide();
            projects_tr.removeClass('shown');
        }
        else {
            // Open this row
            projects_table_row.child('<table id="' + project_id + '"class="table table-striped b-t b-b dataTable no-footer" cellpadding="5" ui-jp="dataTable" cellspacing="0" border="0" style="padding-left:50px;"></table>').show();
            // set subTableid,use project_id

            var subTable = loadContractsOfProject(project_id);

            $(subTable.table().header()).remove();
            projects_tr.addClass('shown');

            $('#' + project_id + ' tbody').on('click', 'td.details-control-sub', function () {
                var tr = $(this).closest('tr');
                var row = subTable.row(tr);
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(contractDetail(row.data())).show();
                    tr.addClass('shown');
                }
            });

        }
    });

    //contract event handler
    $('#contract-basic-modal').on('show.bs.modal', function(e) {
        $(this).find('form')[0].reset();
        var contract = $(e.relatedTarget).data('contract');
        if(contract){
            //set title
            $('#contract-modal-title').text('Update Contract Basic');

            //set content
            $("#customer").val(contract.customer);
            $("#partner_name").val(contract.partner_name);
            $("#sap_nr").val(contract.sap_nr);
            $("#cost_code").val(contract.cost_code);
            $("#manager_name").val(contract.manager_name);
            $("#estimated_value").val(contract.estimated_value);
            $("#work_content").val(contract.work_content);
            $("#contract_delivery").val(formatDate(contract.contract_delivery));
            $("#doc_delivery").val(formatDate(contract.doc_delivery));
            if (contract.contract_typ.electric) {
                $("#is_electric").prop( "checked", true );
            } else {
                $("#is_electric").prop( "checked", false );
            }

            if (contract.contract_typ.water){
                $("#is_water").prop( "checked", true );
            } else {
                $("#is_water").prop( "checked", false );
            }

            if (contract.contract_typ.gas){
                $("#is_gas").prop( "checked", true );
            } else {
                $("#is_gas").prop( "checked", false );
            }

            if (contract.contract_typ.telecom){
                $("#is_telecom").prop( "checked", true );
            } else {
                $("#is_telecom").prop( "checked", false );
            }

            if (contract.contract_typ.light){
                $("#is_light").prop( "checked", true );
            } else {
                $("#is_light").prop( "checked", false );
            }
            if (contract.contract_typ.others){
                $("#is_others").prop( "checked", true );
            } else {
                $("#is_others").prop( "checked", false );
            }

            $("#electric_nr").val(contract.electric_nr);
            $("#water_nr").val(contract.water_nr);
            $("#gas_nr").val(contract.gas_nr);
            if (contract.rot_b){
                $("#rot_b").prop( "checked", true );
            } else {
                $("#rot_b").prop( "checked", false );
            }

            if (contract.isBombExisted){
                $("#isBombExisted").prop( "checked", true );
            } else {
                $("#isBombExisted").prop( "checked", false );
            }

            if (contract.is_building_permission_activ){
                $("#is_building_permission_activ").prop( "checked", true );
            } else {
                $("#is_building_permission_activ").prop( "checked", false );
            }

            if (contract.is_ofw_activ){
                $("#is_ofw_activ").prop( "checked", true );
            } else {
                $("#is_ofw_activ").prop( "checked", false );
            }

            $("#person").val(contract.person);
            $("#reason").val(contract.reason);
            $("#comment").val(contract.comment);
            $("#contract_id").val(contract.id);
            $("#project_id").val(contract.project_id);
            $("#contract_street").val(contract.contract_street);

        } else {
            var project = $(e.relatedTarget).data('project');

            if (project) {
                $("#project_id").val(project.id);
                $("#contract_street").val(project.street+' '+project.housenr);

            }

        }

    });


    $('#contract-permissions-modal').on('show.bs.modal', function(e) {
        var contract = $(e.relatedTarget).data('contract');
        var building_permission = contract.building_permission;
        building_permission.forEach((permission) => {
            var table_content = '<tr>'+'' +
                '<td>'+permission.type+'</td>'+
                '<td>'+permission.begin+'</td>'+
                '<td>'+permission.end+'</td>'+
                '<td>'+permission.cost+'</td>'+
                '<td>'+permission.permission_status+'</td>'+
                '</tr>';
            $('#permissions > tbody:last-child').append(table_content);
        });
    });


    $('#contract-ofw-modal').on('show.bs.modal', function(e) {
        var contract = $(e.relatedTarget).data('contract');
        //set content
        $("#ofw_worker_name").val(contract.ofw.worker_name);
        $("#ofw_permission_nr").val(contract.ofw.permission_nr);
        $("#ofw_delivery").val(contract.ofw.delivery);
        $("#ofw_completion_at").val(contract.ofw.completion_at);
        $("#ofw_ueberdicken").val(contract.ofw.ueberdicken);
        $("#ofw_estimated_value").val(contract.ofw.estimated_value);
        $("#ofw_status").val(contract.ofw.ofw_status);
        if (contract.ofw.typ.bausstr) {
            $("#bausstr").prop( "checked", true );
        } else {
            $("#bausstr").prop( "checked", false );
        }

        if (contract.ofw.typ.fahrbahn){
            $("#fahrbahn").prop( "checked", true );
        } else {
            $("#fahrbahn").prop( "checked", false );
        }

        if (contract.ofw.typ.fussweg){
            $("#fussweg").prop( "checked", true );
        } else {
            $("#fussweg").prop( "checked", false );
        }

        if (contract.ofw.typ.bitu){
            $("#bitu").prop( "checked", true );
        } else {
            $("#bitu").prop( "checked", false );
        }

        if (contract.ofw.typ.pflaster){
            $("#pflaster").prop( "checked", true );
        } else {
            $("#pflaster").prop( "checked", false );
        }

        if (contract.ofw.typ.beton){
            $("#beton").prop( "checked", true );
        } else {
            $("#beton").prop( "checked", false );
        }
        if (contract.ofw.clean){
            $("#clean").prop( "checked", true );
        } else {
            $("#clean").prop( "checked", false );
        }

        if (contract.ofw.is_acceptance_activ){
            $("#is_acceptance_activ").prop( "checked", true );
        } else {
            $("#is_acceptance_activ").prop( "checked", false );
        }
    });

    $('#contract-invoices-modal').on('show.bs.modal', function(e) {
        var contract = $(e.relatedTarget).data('contract');
        var invoices = contract.invoice;
        invoices.forEach((invoice) => {
            var table_content = '<tr>'+
                '<td>'+invoice.rechnung_nr+'</td>'+
                '<td>'+invoice.sum+'</td>'+
                '<td>'+getInvoiceStatus(invoice.invoice_status)+'</td>'+
                '</tr>';
            console.log(table_content);
            $('#invoices > tbody:last-child').append(table_content);
        });
    });

});


function showEditState(id){
  $(id).removeAttr('hidden');
}

function hideEditState(id){
  $(id).attr('hidden', 'hidden');
}

function showInput(type){
  switch(type)
  {
  case 1://manager_name
    $('#manager_name_text').attr('hidden','hidden');
    $('#manager_name_input').removeAttr('hidden');
    $('#manager_name_edit_icon').attr('hidden','hidden');
    $('#manager_name_d').removeAttr('onmouseover');
    $('#manager_name_d').removeAttr('onmouseleave');
    break;
  case 2:
    $('#worker_name_text').attr('hidden','hidden');
    $('#worker_name_input').removeAttr('hidden');
    $('#worker_name_edit_icon').attr('hidden','hidden');
    $('#worker_name_d').removeAttr('onmouseover');
    $('#worker_name_d').removeAttr('onmouseleave');  
    break;
  }
}

function handleEnter(e, type){
  let keynum = 0;
  if(window.event) // IE
  {
    keynum = e.keyCode;
  }
  else if(e.which) // Netscape/Firefox/Opera
  {
    keynum = e.which;
  }
  if(keynum == 13) //enter press
  {
    switch(type)
    {
    case 1://manager_name
      var id = $('#manager_name_input').data('contractid');
      var value = $('#manager_name_input').val();
      postContractEditPartial(id, {'manager_name':value}, function(err){
        if(err) bootbox.alert('update failed!');
        else{
          bootbox.alert('update ok!');
          $('#manager_name_text').text(value);
        }
      });
      $('#manager_name_text').removeAttr('hidden','hidden');
      $('#manager_name_input').attr('hidden', 'hidden');
      $('#manager_name_d').attr('onmouseover', 'showEditState(manager_name_edit_icon)');
      $('#manager_name_d').attr('onmouseleave', 'hideEditState(manager_name_edit_icon)');
      break;
    case 2:
      var id = $('#worker_name_input').data('contractid');
      var value = $('#worker_name_input').val();
      postContractEditPartial(id, {'building_work.worker_name':value}, function(err){
        if(err) bootbox.alert('update failed!');
        else{
          bootbox.alert('update ok!');
          $('#worker_name_text').text(value);
        }
      });
      $('#worker_name_text').removeAttr('hidden','hidden');
      $('#worker_name_input').attr('hidden', 'hidden');
      $('#worker_name_d').attr('onmouseover', 'showEditState(worker_name_edit_icon)');
      $('#worker_name_d').attr('onmouseleave', 'hideEditState(worker_name_edit_icon)');    
      break;
    } 
  }
}

function postContractEditPartial (id, data, callback){
  url = '/contracts/edit/partial/'+id;
  var posting = $.post( url, data );
  posting.done(function( data ) {
    if(data!='ok') {
      let err = 'err';
      callback(err);
    }
    else
      callback(undefined);
  });
}

function printTemplate(id){
  url = '/contracts/print/'+id;
  var posting = $.post( url, {} );
  posting.done(function( data ) { 
    $('#file_tobe_printed').attr('src', data);
    //var iframe = document.getElementById('file_tobe_printed');
    //iframe.contentWindow.print();
    //alert(data);
    return;
    if(data!='ok') {
      let err = 'err';
      callback(err);
    }
    else
      callback(undefined);
  });  
}
</script>
<!-- ############ PAGE END-->
{% endblock %}