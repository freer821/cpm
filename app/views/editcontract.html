{% extends 'layout.html' %}
{% block content %}
<!-- ############ PAGE START-->
<div class="padding">
  <div class="box">
    <div class="box-header">
      <h3>{{project_id}}</h3>
      <small>{{project_adr}}</small>
    </div>
    <div class="box-body">
      <div class="row">
        <div class="col-sm-3 col-lg-2">
          <div class="p-y">
            <div class="nav-active-border left b-primary">
              <ul class="nav nav-sm flex-column">
                <li class="nav-item">
                  <a id="basic_info" class="nav-link block active" href data-toggle="tab" data-target="#tab-1">Basic Info</a>
                </li>
                <li class="nav-item">
                  <a id="building" class="nav-link block" href data-toggle="tab" data-target="#tab-2">Building</a>
                </li>
                <li  class="nav-item">
                  <a id="building_permission" class="nav-link block" href data-toggle="tab" data-target="#tab-3">Building Permission</a>
                </li>
                <li class="nav-item">
                  <a id="ofw" class="nav-link block" href data-toggle="tab" data-target="#tab-4">OFW Status</a>
                </li>
                <li class="nav-item">
                  <a id="financial" class="nav-link block" href data-toggle="tab" data-target="#tab-5">financial accounting</a>
                </li>
                <li class="nav-item">
                  <a id="fibu" class="nav-link block" href data-toggle="tab" data-target="#tab-6">Fibu</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-sm-9 col-lg-10 light lt" style="padding-left: 0px; padding-right: 0px">
          <div class="tab-content pos-rlt">
            <div class="tab-pane active"  id="tab-1">
              <div class="p-a-md dker _600" >Basic Info</div>
              {% include 'edit_contract_basic.html' %}
            </div>
            <div class="tab-pane" id="tab-2">
              <div class="p-a-md dker _600">Buliding</div>
              {% include 'edit_contract_building.html' %}
            </div>
            <div class="tab-pane" id="tab-3">
              <div class="p-a-md dker _600">Building Permission</div>
              {% include 'edit_contract_building_permission.html' %}
            </div>
            <div class="tab-pane" id="tab-4">
              <div class="p-a-md dker _600">OFW Status</div>
              {% include 'edit_contract_ofw.html' %}
            </div>
            <div class="tab-pane" id="tab-5">
              <div class="p-a-md dker _600">Financial Accounting</div>
              {% include 'edit_contract_financial.html' %}
            </div>
            <div class="tab-pane" id="tab-6">
              <div class="p-a-md dker _600">Fibu</div>
              {% include 'edit_contract_fibu.html' %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ############ PAGE END-->

<!-- ############ Modal Begin-->
<div id="edit-permission" class="modal" data-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    <form id="form" action="/contracts/edit/permission" method="post" >
      <div class="modal-header">
        <h5 class="modal-title">Edit Permission</h5>
      </div>
      <div class="modal-body">
        
        <div class="form-group row">
          <label class="col-md-1 form-control-label">Type</label>
          <div class="col-md-11">
            <select class="form-control c-select" id="tpye" name="type">
              <option value="BAZ">BAZ</option>
              <option value="VAZ">VAZ</option>
              <option value="VBA">VBA</option>
            </select>
          </div>
        </div>   
        
        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Doc Delivery</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="doc_delivery" name="doc_delivery">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>  

        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Permission Begin</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="begin" name="begin">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Permission End</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="end" name="end">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-md-1 form-control-label">Cost</label>
          <div class="col-md-11">
            <input type="text" class="form-control" id="cost" name="cost"> 
          </div>
        </div>   

        <div class="form-group row">
          <label class="col-md-1 form-control-label">Status</label>
          <div id="per_status" class="col-md-11 progress mb-4">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <input type="hidden" name="contract_id" value="{{contract.id}}">
        <input type="hidden" id="permission_id" name="permission_id" value="">
        <input type="hidden" name="project_id" value="{{project_id}}">
        <input type="hidden" name="project_adr" value="{{project_adr}}">
        <button type="button" class="btn dark-white p-x-md" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn danger p-x-md">Submit</button>
      </div>
    </form>
    </div><!-- /.modal-content -->
  </div>
</div>

<div id="edit-invocie" class="modal" data-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    <form id="form" action="/contracts/edit/invocie" method="post" >
      <div class="modal-header">
        <h5 class="modal-title">New Invocie</h5>
      </div>
      <div class="modal-body">
        
        <div class="form-group row">
          <label class="col-md-1 form-control-label">Invoice Nr.</label>
          <div class="col-md-11">
            <input type="text" class="form-control" id="rechnung_nr" name="rechnung_nr">
          </div>
        </div>  

         <div class="form-group row">
          <label class="col-md-1 form-control-label">Current Value</label>
          <div class="col-md-11">
            <input type="text" class="form-control" id="current_value" name="current_value">
          </div>
        </div>   
        <div class="form-group row">
          <label class="col-md-1 form-control-label">Sum Value</label>
          <div class="col-md-11">
            <input type="text" class="form-control" id="sum" name="sum">
          </div>
        </div>   
       
        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Invocie Send</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="aufmass_am" name="aufmass_am">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>  

        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Invocie Permitted</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="bewert_aufmass" name="bewert_aufmass">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Permission End</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="end" name="end">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-sm-3 form-control-label">Invocie Paid</label>
          <div class='input-group date col-sm-9' ui-jp="datetimepicker" ui-options="{
                    format: 'DD-MM-YYYY',
                    icons: {
                      time: 'fa fa-clock-o',
                      date: 'fa fa-calendar',
                      up: 'fa fa-chevron-up',
                      down: 'fa fa-chevron-down',
                      previous: 'fa fa-chevron-left',
                      next: 'fa fa-chevron-right',
                      today: 'fa fa-screenshot',
                      clear: 'fa fa-trash',
                      close: 'fa fa-remove'
                    }
                  }">
            <input type='text' class="form-control" id="guts_datum" name="guts_datum">
            <span class="input-group-addon">
              <span class="fa fa-calendar"></span>
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-md-1 form-control-label">Status</label>
          <div id="per_status" class="col-md-11 progress mb-4">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <input type="hidden" name="contract_id" value="{{contract.id}}">
        <input type="hidden" id="invocie_id" name="invocie_id" value="">
        <input type="hidden" name="project_id" value="{{project_id}}">
        <input type="hidden" name="project_adr" value="{{project_adr}}">        
        <button type="button" class="btn dark-white p-x-md" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn danger p-x-md">Submit</button>
      </div>
    </form>
    </div><!-- /.modal-content -->
  </div>
</div>

<div id="del-item" class="modal" data-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete</h5>
      </div>
      <div class="modal-body text-center p-lg">
        <p>Are you sure to delete : <span id="delitemtitle" style="font-weight:bold"></span>?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn dark-white p-x-md" data-dismiss="modal">No</button>
        <a type="button" class="btn danger p-x-md">Yes</a>
      </div>
    </div><!-- /.modal-content -->
  </div>
</div>
<!-- ############ Modal End-->


<script type="text/javascript">

// Attach a submit handler to the form
$("form").submit(function( event ) {
  // Get some values from elements on the page:
  url = $(this).attr( "action" );
  if (url != '/contracts/edit/permission' && url !='/contracts/edit/invocie'){
    // Stop form from submitting normally
    event.preventDefault();
   
    // Send the data using post
    var posting = $.post( url, $(this).serialize() );
   
    // Put the results in a div
    posting.done(function( data ) {
      bootbox.alert(data);
    });  
  }
});

$('#edit-permission').on('show.bs.modal', function(e) {
    $(this).find('form')[0].reset();
    var permission = $(e.relatedTarget).data('permission');
    if (permission) {
      $("#tpye").val(permission.type);
      $("#doc_delivery").val(moment(permission.doc_delivery).format("DD-MM-YYYY"));
      $("#begin").val(moment(permission.begin).format("DD-MM-YYYY"));
      $("#end").val(moment(permission.end).format("DD-MM-YYYY"));
      $("#cost").val(permission.cost);
      $("#permission_id").val(permission._id);
    }
  });

$('#edit-invocie').on('show.bs.modal', function(e) {
    $(this).find('form')[0].reset();
    var invocie = $(e.relatedTarget).data('invocie');
    if (invocie) {
      $("#rechnung_nr").val(invocie.rechnung_nr);
      $("#current_value").val(invocie.current_value);
      $("#sum").val(invocie.sum);
      $("#aufmass_am").val(moment(invocie.aufmass_am).format("DD-MM-YYYY"));
      $("#bewert_aufmass").val(moment(invocie.bewert_aufmass).format("DD-MM-YYYY"));
      $("#end").val(moment(invocie.end).format("DD-MM-YYYY"));
      $("#guts_datum").val(moment(invocie.guts_datum).format("DD-MM-YYYY"));
      $("#invocie_id").val(invocie._id);
    }
  });

$('#del-item').on('show.bs.modal', function(e) {
      $("#delitemtitle").html($(e.relatedTarget).data('item-tilte'));
      $(this).find('.danger').attr('href', $(e.relatedTarget).data('href'));
  });

$("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 0%">0%</div>');

$("#building_status").on('change', function() {
  $("#procent_completion").empty();
  switch(this.value) {
    case '00':
      $("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 0%">0%</div>');
      break;
    case '01':
      $("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 10%">10%</div>');
      break;
    case '02':
      $("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 80%">80%</div>');
      break;
    case '03':
      $("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 100%">100%</div>');
      break;
    case '04':
      $("#procent_completion").append('<div class="progress-bar progress-bar-striped progress-bar-animated primary" style="width: 100%">100%</div>');
      break;
  }
});

{% if contract.ofw.is_acceptance_activ %}
  $("#add_acceptance").append(getAcceptanceForm());
  $("#applied").val("{% if contract.ofw.acceptance.applied %}{{contract.ofw.acceptance.applied | date('d-m-Y')}}{% endif %}");
  $("#granted").val("{% if contract.ofw.acceptance.granted %}{{contract.ofw.acceptance.granted | date('d-m-Y')}}{% endif %}");
{% endif %}

$("#is_acceptance_activ").on('change', function() {
  if($(this).is(":checked")) {
      $("#add_acceptance").append(getAcceptanceForm());
      $("#applied").val("{% if contract.ofw.acceptance.applied %}{{contract.ofw.acceptance.applied | date('d-m-Y')}}{% endif %}");
      $("#granted").val("{% if contract.ofw.acceptance.granted %}{{contract.ofw.acceptance.granted | date('d-m-Y')}}{% endif %}");
  } else {
    $("#add_acceptance").empty();
  }
});

function getAcceptanceForm() {
    return '<div class="col-sm-6">'+
        '<div class="form-group row">'+
        ' <label class="col-sm-2 form-control-label">applied</label>'+
        '<div class="col-sm-10">'+
        '<div class=\'input-group date col-sm-9\' ui-jp="datetimepicker" ui-options="{'+"format: 'DD-MM-YYYY',"+
        ' icons: {'+
        '  time: \'fa fa-clock-o\','+
        ' date: \'fa fa-calendar\','+
        '  up: \'fa fa-chevron-up\','+
        '  down: \'fa fa-chevron-down\','+
        '  previous: \'fa fa-chevron-left\','+
        '  next: \'fa fa-chevron-right\','+
        '  today: \'fa fa-screenshot\','+
        '  clear: \'fa fa-trash\','+
        '  close: \'fa fa-remove\''+
        '}'+
        '}">'+
        '<input type=\'text\' class="form-control" id="applied" name="applied">'+
        '<span class="input-group-addon">'+
        '    <span class="fa fa-calendar"></span>'+
        '</span>'+
        '</div>  '+
        ' </div>'+
        ' </div> '+
        ' </div> '+
        '<div class="col-sm-6">'+
        ' <div class="form-group row">'+
        '   <label class="col-sm-2 form-control-label">granted</label>'+
        '   <div class="col-sm-10">'+
        '     <div class=\'input-group date col-sm-9\' ui-jp="datetimepicker" ui-options="{'+"format: 'DD-MM-YYYY',"+
        '         icons: {'+
        '           time: \'fa fa-clock-o\','+
        '           date: \'fa fa-calendar\','+
        '           up: \'fa fa-chevron-up\','+
        '           down: \'fa fa-chevron-down\','+
        '           previous: \'fa fa-chevron-left\','+
        '           next: \'fa fa-chevron-right\','+
        '           today: \'fa fa-screenshot\','+
        '           clear: \'fa fa-trash\','+
        '           close: \'fa fa-remove\''+
        '         }'+
        '       }">'+
        '     <input type=\'text\' class="form-control" id="granted" name="granted">'+
        '     <span class="input-group-addon">'+
        '         <span class="fa fa-calendar"></span>'+
        '     </span>'+
        '   </div> '+
        '   </div>'+
        ' </div> '+
        '</div>';
}

function calStatusOfBuilding() {
  if (moment($("#plan_begin").val(), "DD-MM-YYYY", true).isValid()  && moment($("#plan_end").val(), "DD-MM-YYYY", true).isValid() ) {
    var now = moment();
    var building_begin = moment($("#plan_begin").val(),"DD-MM-YYYY");
    var building_end = moment($("#plan_end").val(),"DD-MM-YYYY");

    console.log($("#plan_end").val());

    if (now.isAfter(building_end)) {
      $("#building_status").val('03');
    } else if (now.isAfter(building_begin)) {
      $("#building_status").val('02');
    }
  } else {
    $("#building_status").val('01');
  }

  $("#building_status").change();
}

calStatusOfBuilding();

$('#plan_end_div').on('dp.change', function (ev) {
    calStatusOfBuilding();
});

$(document).ready(function() {
  {% if jump_building_permission %}
    bootbox.alert('update building_permission done!');
    $('#building_permission')[0].click();
  {% endif %}
  {% if jump_financial %}
    bootbox.alert('update invocie done!');
    $('#financial')[0].click();
  {% endif %}
});
</script>
{% endblock %}
